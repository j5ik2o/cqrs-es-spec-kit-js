# ハンズオン要件: Cart 予算上限と合計金額の不変条件

## 目的
CQRS/ES の流れ（コマンド → イベント → RMU → クエリ）を体験できるように、既存の Cart 実装に「予算上限」と「合計金額」を追加する。

## 方針
- 予算上限は **カート作成時にのみ設定可能** とする。
- 予算上限は **Option（未設定/設定済み）** として扱う。
- 予算未設定のときは **addItem を許可** する。
- 金額は **Money 型** を導入して扱う。
- 予算超過は **コマンド側の不変条件違反** としてエラーにする。

## 用語
- **Budget**: カートの予算上限（Option）
- **Total**: カート内アイテムの合計金額（Money）
- **Money**: 金額を表現する値オブジェクト

## Event Storming の前提モデル
要件の前提として、以下のイベント・コマンド・集約・リードモデルを前提にする。

### イベント
- `CartCreated`（budget を含む）
- `CartItemAdded`
- `CartItemRemoved`

### コマンド
- `CreateCart`（budget は Option）
- `AddCartItem`
- `RemoveCartItem`

### 集約
- `Cart`（予算上限と合計金額の不変条件を担保する）

### リードモデル
- `CartSummary`（例: `budget`, `total` を保持して Read API に提供する）

## EARS 形式の要件

### 1. 作成時の予算設定（コマンド）
1. ユーザーがカートを作成し予算を指定したとき、システムは budget を含む `CartCreated` を発行しなければならない。
2. ユーザーがカートを作成し予算を指定しないとき、システムは budget が None の `CartCreated` を発行しなければならない。
3. カート作成後に予算を変更するコマンドは存在しない（変更は行わない）。

### 2. カートアイテム追加時の予算チェック（コマンド）
1. ユーザーがアイテム追加を要求したとき、システムは合計金額を計算しなければならない（合計金額の計算は public メソッドとして提供する）。
2. 予算が設定されており、合計金額が上限を超えるとき、システムはエラーを返さなければならない。
3. 予算が未設定（None）のとき、システムは追加を許可し、`CartItemAdded` を発行しなければならない。
4. 予算が設定されており、合計金額が上限以内のとき、システムは `CartItemAdded` を発行しなければならない。
5. 追加が成功したとき、システムは `CartItemAdded` と **新しい状態を持つ Cart インスタンス** を返さなければならない（集約はイミュータブルであるため）。
6. 新しい Cart インスタンスの生成時は、**上限金額を超えない** という不変条件を満たさなければならない。

### 3. カートアイテム削除時の合計金額（コマンド）
1. ユーザーがアイテム削除を要求したとき、システムは合計金額を再計算しなければならない。
2. システムは削除後の状態を有効な Cart として保持しなければならない。
3. 削除が成功したとき、システムは `CartItemRemoved` と **新しい状態を持つ Cart インスタンス** を返さなければならない（集約はイミュータブルであるため）。
4. 新しい Cart インスタンスの生成時は、**上限金額を超えない** という不変条件を満たさなければならない。

### 4. 金額の表現
1. システムは金額を `Money` として扱わなければならない。
2. システムは合計金額を `Money` として保持しなければならない。
3. `Money`はマイナス表現になってはいけない。
4. `Money`は分量のみならず通貨単位を持つこと（通貨は固定、例: JPY）。
5. `Money`どうしの加算・減算ができること。ただし、通貨単位が異なるインスタンスどうしの計算はエラーとなること。

### 5. Read Model 反映（確認用）
1. `CartCreated` を受信したとき、RMU は Read Model の budget を更新しなければならない。
2. `CartItemAdded` / `CartItemRemoved` を受信したとき、RMU は Read Model の total を更新しなければならない。

## 受け入れ条件（簡易）
- 予算未設定のカートでは addItem が成功する。
- 予算設定後、上限超過の addItem はエラーになる。
- 予算はカート作成時にのみ設定され、作成後は変更されない。
- Read API から budget と total を取得できる。

## スコープ外
- 予算の再設定・解除
- 複数通貨対応
- 小数対応
- 割引やクーポン

## 次のステップ（当日作業）
- この内容を元に spec（requirements / design / tasks）を作成する。
- 既存 Cart 実装に追加する形で TDD 実装する。
