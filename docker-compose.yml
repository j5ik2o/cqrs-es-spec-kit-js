version: '3.6'
services:
  # Database Services
  mysql:
    image: mysql:9.3
    hostname: mysql-local
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --ngram_token_size=2
    healthcheck:
      test: MYSQL_PWD=passwd mysql -h127.0.0.1 -P3306 -uroot -e "quit"
    ports:
      - 33306:3306
    environment:
      MYSQL_ROOT_PASSWORD: passwd
      MYSQL_USER: ceer
      MYSQL_PASSWORD: ceer
      MYSQL_DATABASE: ceer

  migration:
    image: migrate/migrate:v4.18.3
    volumes:
      - ./tools/migrate/migrations:/migrations
    entrypoint:
      [
        "migrate",
        "-path",
        "/migrations",
        "-database",
        "mysql://ceer:ceer@tcp(mysql-local:3306)/ceer",
      ]
    command: [ "up" ]
    depends_on:
      mysql:
        condition: service_healthy
    restart: on-failure

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    environment:
      - PMA_ARBITRARY=1
      - PMA_HOST=mysql
      - PMA_USER=root
      - PMA_PASSWORD=passwd
    ports:
      - 24040:80
    depends_on:
      - mysql

  localstack:
    image: localstack/localstack:2.3.2
    hostname: localstack-local
    ports:
      - "34566:4566"
      - "34571:4571"
      - "${PORT_WEB_UI-38083}:${PORT_WEB_UI-8080}"
    environment:
      DEBUG: 1
      LOCALSTACK_API_KEY: ${LOCALSTACK_API_KEY- }
      PORT_WEB_UI: ${PORT_WEB_UI- }
      PARITY_AWS_ACCESS_KEY_ID: 1
      EAGER_SERVICE_LOADING: 1
      SERVICES: cloudwatch,dynamodb,dynamodbstreams
      HOSTNAME_EXTERNAL: localstack-local
      DEFAULT_REGION: ap-northeast-1
      DYNAMODB_SHARE_DB: 1
      DYNAMODB_IN_MEMORY: 1
    volumes:
      - "${TMPDIR:-/tmp/localstack}:/tmp/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  dynamodb-setup:
    image: mesosphere/aws-cli
    environment:
      AWS_ACCESS_KEY_ID: x
      AWS_SECRET_ACCESS_KEY: x
      AWS_DEFAULT_REGION: ap-northeast-1
      DYNAMODB_ENDPOINT: localstack:4566
      JOURNAL_TABLE_NAME: journal
      JOURNAL_GSI_NAME: journal-aid-index
      SNAPSHOT_TABLE_NAME: snapshot
      SNAPSHOT_GSI_NAME: snapshot-aid-index
    volumes:
      - ./tools/dynamodb-setup:/setup
    entrypoint: [ "" ]
    command: [ "/setup/create-tables.sh", "-e", "dev" ]
    depends_on:
      localstack:
        condition: service_healthy

  dynamodb-admin:
    image: aaronshaf/dynamodb-admin
    ports:
      - "38003:8001"
    environment:
      DYNAMO_ENDPOINT: http://localstack:4566
      AWS_DEFAULT_REGION: ap-northeast-1
    depends_on:
      - dynamodb-setup

  # Application Services
  write-api-server:
    command: ["writeApi"]
    image: cqrs-es-spec-kit-js:latest
    container_name: write-api-server-js
    ports:
      - 38080:3000
    environment:
      AWS_REGION: ap-northeast-1
      API_HOST: "0.0.0.0"
      API_PORT: 3000
      API_ALLOW_ORIGINS: "http://localhost:38080,http://localhost:38082,http://localhost:8888"
      PERSISTENCE_JOURNAL_TABLE_NAME: journal
      PERSISTENCE_JOURNAL_AID_INDEX_NAME: journal-aid-index
      PERSISTENCE_SNAPSHOT_TABLE_NAME: snapshot
      PERSISTENCE_SNAPSHOT_AID_INDEX_NAME: snapshot-aid-index
      PERSISTENCE_SHARD_COUNT: 64
      PERSISTENCE_SNAPSHOT_INTERVAL: 10
      AWS_REGION_NAME: ${AWS_REGION}
      AWS_DYNAMODB_ENDPOINT_URL: http://localstack:4566
      AWS_DYNAMODB_ACCESS_KEY_ID: x
      AWS_DYNAMODB_SECRET_ACCESS_KEY: x
    depends_on:
      localstack:
        condition: service_healthy
      dynamodb-admin:
        condition: service_started
      dynamodb-setup:
        condition: service_completed_successfully

  read-model-updater:
    command: [ "localRmu" ]
    image: cqrs-es-spec-kit-js:latest
    container_name: read-model-updater-js
    ports:
      - 38081:8080
    environment:
      AWS_REGION: ap-northeast-1
      API_HOST: "0.0.0.0"
      API_PORT: 8080
      AWS_REGION_NAME: ap-northeast-1
      AWS_DYNAMODB_ENDPOINT_URL: http://localstack:4566
      AWS_DYNAMODB_ACCESS_KEY_ID: x
      AWS_DYNAMODB_SECRET_ACCESS_KEY: x
      STREAM_JOURNAL_TABLE_NAME: journal
      STREAM_MAX_ITEM_COUNT: 32
      DATABASE_URL: mysql://ceer:ceer@mysql-local:3306/ceer
    depends_on:
      localstack:
        condition: service_healthy
      dynamodb-admin:
        condition: service_started
      dynamodb-setup:
        condition: service_completed_successfully
      mysql:
        condition: service_healthy
      migration:
        condition: service_completed_successfully

  read-api-server:
    command: [ "readApi" ]
    image: cqrs-es-spec-kit-js:latest
    container_name: read-api-server-js
    ports:
      - 38082:3000
    environment:
      AWS_REGION: ap-northeast-1
      API_HOST: "0.0.0.0"
      API_PORT: 3000
      API_ALLOW_ORIGINS: "http://localhost:38080,http://localhost:38082,http://localhost:8888"
      DATABASE_URL: mysql://ceer:ceer@mysql-local:3306/ceer
    depends_on:
      mysql:
        condition: service_healthy
      migration:
        condition: service_completed_successfully
      write-api-server:
        condition: service_started
      read-model-updater:
        condition: service_started
