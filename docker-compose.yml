services:
  # Database Services
  mysql:
    image: mysql:9.3
    hostname: mysql-local
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --ngram_token_size=2
    healthcheck:
      test: MYSQL_PWD=passwd mysql -h127.0.0.1 -P3306 -uroot -e "quit"
    ports:
      - 33306:3306
    environment:
      MYSQL_ROOT_PASSWORD: passwd
      MYSQL_USER: orderdb
      MYSQL_PASSWORD: orderdb
      MYSQL_DATABASE: orderdb

  migration:
    image: migrate/migrate:v4.18.3
    volumes:
      - ./tools/migrate/migrations:/migrations
    entrypoint:
      [
        "migrate",
        "-path",
        "/migrations",
        "-database",
        "mysql://orderdb:orderdb@tcp(mysql-local:3306)/orderdb",
      ]
    command: [ "up" ]
    depends_on:
      mysql:
        condition: service_healthy
    restart: on-failure

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    environment:
      - PMA_ARBITRARY=1
      - PMA_HOST=mysql
      - PMA_USER=root
      - PMA_PASSWORD=passwd
    ports:
      - 24040:80
    depends_on:
      - mysql

  localstack:
    image: localstack/localstack:3.8
    hostname: localstack-local
    ports:
      - "34566:4566"
      - "34571:4571"
      - "${PORT_WEB_UI-38083}:${PORT_WEB_UI-8080}"
    environment:
      DEBUG: 1
      LOCALSTACK_API_KEY: ${LOCALSTACK_API_KEY- }
      PORT_WEB_UI: ${PORT_WEB_UI- }
      PARITY_AWS_ACCESS_KEY_ID: 1
      EAGER_SERVICE_LOADING: 1
      SERVICES: cloudwatch,dynamodb,dynamodbstreams,lambda
      HOSTNAME_EXTERNAL: localstack-local
      DEFAULT_REGION: ap-northeast-1
      # DYNAMODB_SHARE_DB: 0 is required for DynamoDB Streams to work properly
      DYNAMODB_SHARE_DB: 0
      DYNAMODB_IN_MEMORY: 0
      LAMBDA_EXECUTOR: docker
      LAMBDA_REMOTE_DOCKER: 0
      LAMBDA_RUNTIME_ENVIRONMENT_TIMEOUT: 180
      LAMBDA_REMOVE_CONTAINERS: true
      LAMBDA_DOCKER_NETWORK: cqrs-es-spec-kit-js_default
      LOCALSTACK_HOST: localstack-local:4566
      MAIN_CONTAINER_NAME: cqrs-es-spec-kit-js-localstack-1
      DOCKER_HOST: unix:///var/run/docker.sock
      PERSISTENCE: 0
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  dynamodb-setup:
    image: mesosphere/aws-cli
    environment:
      AWS_ACCESS_KEY_ID: x
      AWS_SECRET_ACCESS_KEY: x
      AWS_REGION: ap-northeast-1
      AWS_DEFAULT_REGION: ap-northeast-1
      DYNAMODB_ENDPOINT: localstack:4566
      JOURNAL_TABLE_NAME: journal
      JOURNAL_GSI_NAME: journal-aid-index
      SNAPSHOT_TABLE_NAME: snapshot
      SNAPSHOT_GSI_NAME: snapshot-aid-index
    volumes:
      - ./tools/dynamodb-setup:/setup
    entrypoint: [ "" ]
    command: [ "/setup/create-tables.sh", "-e", "dev" ]
    depends_on:
      localstack:
        condition: service_healthy

  dynamodb-admin:
    image: aaronshaf/dynamodb-admin
    ports:
      - "38003:8001"
    environment:
      DYNAMO_ENDPOINT: http://localstack:4566
      AWS_DEFAULT_REGION: ap-northeast-1
    depends_on:
      - dynamodb-setup

  # Application Services
  write-api-server:
    command: ["writeApi"]
    image: cqrs-es-spec-kit-js:latest
    container_name: write-api-server-js
    ports:
      - 38080:3000
    environment:
      AWS_REGION: ap-northeast-1
      API_HOST: "0.0.0.0"
      API_PORT: 3000
      API_ALLOW_ORIGINS: "http://localhost:38080,http://localhost:38082,http://localhost:8888"
      PERSISTENCE_JOURNAL_TABLE_NAME: journal
      PERSISTENCE_JOURNAL_AID_INDEX_NAME: journal-aid-index
      PERSISTENCE_SNAPSHOT_TABLE_NAME: snapshot
      PERSISTENCE_SNAPSHOT_AID_INDEX_NAME: snapshot-aid-index
      PERSISTENCE_SHARD_COUNT: 64
      PERSISTENCE_SNAPSHOT_INTERVAL: 10
      AWS_REGION_NAME: ${AWS_REGION}
      AWS_DYNAMODB_ENDPOINT_URL: http://localstack:4566
      AWS_DYNAMODB_ACCESS_KEY_ID: x
      AWS_DYNAMODB_SECRET_ACCESS_KEY: x
    depends_on:
      localstack:
        condition: service_healthy
      dynamodb-admin:
        condition: service_started
      dynamodb-setup:
        condition: service_completed_successfully

  # Lambda-based Read Model Updater
  lambda-setup:
    image: cqrs-es-spec-kit-js:latest
    container_name: lambda-setup-js
    user: root
    environment:
      AWS_REGION: ap-northeast-1
      AWS_ENDPOINT_URL: http://localstack:4566
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      LAMBDA_FUNCTION_NAME: read-model-updater
      LAMBDA_ZIP_PATH: /app/modules/bootstrap/dist/lambda/function.zip
      DATABASE_URL: mysql://orderdb:orderdb@mysql-local:3306/orderdb
      STREAM_JOURNAL_TABLE_NAME: journal
      EVENT_BATCH_SIZE: 10
      MAX_RETRY_ATTEMPTS: 2
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache aws-cli

        echo "üöÄ Deploying Lambda function..."

        # Create or update Lambda function
        if aws lambda get-function --function-name read-model-updater --endpoint-url http://localstack:4566 --region ap-northeast-1 2>/dev/null; then
          echo "Updating existing Lambda function..."
          aws lambda update-function-code \
            --function-name read-model-updater \
            --zip-file fileb:///app/modules/bootstrap/dist/lambda/function.zip \
            --endpoint-url http://localstack:4566 \
            --region ap-northeast-1
        else
          echo "Creating new Lambda function..."
          aws lambda create-function \
            --function-name read-model-updater \
            --runtime nodejs18.x \
            --handler index.handler \
            --role arn:aws:iam::000000000000:role/lambda-role \
            --zip-file fileb:///app/modules/bootstrap/dist/lambda/function.zip \
            --timeout 60 \
            --memory-size 512 \
            --environment "Variables={DATABASE_URL=mysql://orderdb:orderdb@mysql-local:3306/orderdb}" \
            --endpoint-url http://localstack:4566 \
            --region ap-northeast-1
        fi

        echo "üîó Creating Event Source Mapping..."

        # Wait for DynamoDB Stream to be available
        for i in 1 2 3 4 5; do
          STREAM_ARN=$$(aws dynamodb describe-table \
            --table-name journal \
            --endpoint-url http://localstack:4566 \
            --region ap-northeast-1 \
            --query 'Table.LatestStreamArn' \
            --output text 2>/dev/null)

          if [ -n "$$STREAM_ARN" ] && [ "$$STREAM_ARN" != "None" ]; then
            break
          fi
          echo "Waiting for DynamoDB Stream... (attempt $$i)"
          sleep 2
        done

        echo "Stream ARN: $$STREAM_ARN"

        # Validate Stream ARN
        if [ -z "$$STREAM_ARN" ] || [ "$$STREAM_ARN" = "None" ]; then
          echo "ERROR: DynamoDB Stream ARN not found!"
          exit 1
        fi

        # Check if Event Source Mapping already exists
        EXISTING_MAPPINGS=$$(aws lambda list-event-source-mappings \
          --function-name read-model-updater \
          --endpoint-url http://localstack:4566 \
          --region ap-northeast-1 \
          --query 'EventSourceMappings[?EventSourceArn==`'"$$STREAM_ARN"'`].UUID' \
          --output text 2>/dev/null)

        if [ -n "$$EXISTING_MAPPINGS" ]; then
          echo "Event Source Mapping already exists: $$EXISTING_MAPPINGS"
        else
          echo "Creating new Event Source Mapping..."
          aws lambda create-event-source-mapping \
            --function-name read-model-updater \
            --event-source-arn "$$STREAM_ARN" \
            --starting-position LATEST \
            --batch-size 10 \
            --maximum-retry-attempts 2 \
            --endpoint-url http://localstack:4566 \
            --region ap-northeast-1
        fi

        echo "‚úÖ Lambda setup completed successfully"
    depends_on:
      localstack:
        condition: service_healthy
      dynamodb-setup:
        condition: service_completed_successfully
      mysql:
        condition: service_healthy
      migration:
        condition: service_completed_successfully

  # Lambda-based RMU „ÅÆ„Åø‰ΩøÁî®ÔºàlocalRmu „ÅØÂâäÈô§Ê∏à„ÅøÔºâ

  read-api-server:
    command: [ "readApi" ]
    image: cqrs-es-spec-kit-js:latest
    container_name: read-api-server-js
    ports:
      - 38082:3000
    environment:
      AWS_REGION: ap-northeast-1
      API_HOST: "0.0.0.0"
      API_PORT: 3000
      API_ALLOW_ORIGINS: "http://localhost:38080,http://localhost:38082,http://localhost:8888"
      DATABASE_URL: mysql://orderdb:orderdb@mysql-local:3306/orderdb
    depends_on:
      mysql:
        condition: service_healthy
      migration:
        condition: service_completed_successfully
      write-api-server:
        condition: service_started
      lambda-setup:
        condition: service_completed_successfully
