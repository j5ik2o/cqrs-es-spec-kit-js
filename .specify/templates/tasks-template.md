---

description: "フィーチャ実装のためのタスクテンプレート"
---

# タスク: [FEATURE NAME]

**入力**: `/specs/[###-feature-name]/` 配下のドキュメント  
**事前条件**: plan.md（必須）、spec.md（必須）、research.md、data-model.md、contracts/

**テスト**: テストタスクは必須。各ユースケースの単体・契約・統合テストを先に追加し、回復可能・回復不能エラーの扱いを含めて実装前に失敗させる。

**編成方針**: タスクはユーザーストーリー単位にグルーピングし、独立した実装・テスト・デプロイを可能にする。

## 表記形式: `[ID] [P?] [Story] 説明`

- **[P]**: 並列実行可能（異なるファイルで依存関係なし）の場合に付与する。
- **[Story]**: 対応するユーザーストーリー。例: US1, US2, US3。
- 説明には正確なファイルパスを記載する。

## パス規約

- **標準構成**: `src/domain`, `src/application`, `src/interfaces`, `tests/`（リポジトリ直下）
- **Web 構成例**: `backend/src/`, `frontend/src/`（必要時）
- **モバイル構成例**: `api/src/`, `ios/src/` または `android/src/`
- plan.md の構成方針と矛盾しないよう必要に応じて修正する。

<!--
  ============================================================================
  注意: 以下のタスクはサンプル。/speckit.tasks コマンドは実際の仕様に合わせて生成する。
  - spec.md のユーザーストーリー（優先度を含む）
  - plan.md の技術方針
  - data-model.md のエンティティ
  - contracts/ の契約
  を反映し、ユーザーストーリーごとに独立した MVP を構築できること。
  ============================================================================
-->

## フェーズ1: セットアップ（共通基盤）

**目的**: プロジェクト構造とツールチェーンの初期化

- [ ] T001 実装計画に沿ってディレクトリと基盤コードを整備する
- [ ] T002 選定したフレームワークと依存ライブラリを導入する
- [ ] T003 [P] Lint/フォーマッタ/型チェックを設定する

---

## フェーズ2: 基盤整備（全ユースケースの前提）

**目的**: すべてのユースケース実装前に必要なアプリケーション・インフラ基盤を構築する

**⚠️ 重要**: このフェーズが完了するまでユーザーストーリー実装を開始してはならない。

- [ ] T004 ユースケース共通のドメインエンティティ・値オブジェクトを定義する
- [ ] T005 [P] アプリケーションサービスのポート・例外方針を確立する
- [ ] T006 [P] 永続化・API などのアダプタ骨格を作成する
- [ ] T007 監査ログ・トレースなど横断的関心事を組み込む
- [ ] T008 環境変数管理・設定読み込みの仕組みを整える
- [ ] T009 インメモリリポジトリを `src/interfaces/repository/in-memory` に実装し、ユースケーステストから利用できるようにする
- [ ] T010 インフラストラクチャ共通ユーティリティ（ロギング・設定・ID 生成など）を `infrastructure/` 以下に整備する（IO を含めない）
- [ ] T011 [P] `@j5ik2o/event-store-adapter-js` の接続設定を `infrastructure/` に実装し、ストリーム命名規約と環境変数を整備する
- [ ] T012 イベント投影/サブスクライバの基盤（イベントバス・リードモデル更新）を用意し、ユニットテストで再生可能にする
- [ ] T013 エラーハンドリング方針をドキュメントに反映し、回復可能/不能の分類と戻り値型・例外境界を明記する
- [ ] T014 `references/event-store-adapter-js` と `references/cqrs-es-example-js` をレビューし、設計意図のみ参照して差分を記録（コードのコピーや改変取り込みは禁止）。CQRS のクエリ側がドメインモデル・リポジトリへ依存せずリードデータベースへ直接アクセスする設計になっているか確認する

**チェックポイント**: 基盤が整い、各ユースケースが独立に着手可能になった状態。

---

## フェーズ3: ユーザーストーリー 1 - [タイトル]（優先度: P1）🎯 MVP

**ゴール**: [このストーリーが提供する価値を簡潔に記述]

**独立テスト方法**: [単体で検証する手順]

### テスト（必須）

> **重要**: 以下のテストタスクを先に実装し、失敗することを確認してから機能を実装する。

- [ ] T015 [P] [US1] ドメイン単体テストを `tests/unit/` に追加する（回復可能エラーと正常系を検証）
- [ ] T016 [P] [US1] ポート契約テストを `tests/contract/` に追加する（例外変換を含む）
- [ ] T017 [P] [US1] 統合テストを `tests/integration/` に追加する（外部エラー伝播と代替フローを検証）

### 実装

- [ ] T018 [P] [US1] ドメインモデルを `src/domain/...` に追加する
- [ ] T019 [P] [US1] ユースケースサービスを `src/application/use-cases/...` に実装する（Either/Result によるエラー制御を含む）
- [ ] T020 [US1] アダプタを `src/interfaces/...` に実装し、ポートを満たす（例外をドメイン向けエラーに変換し、RPC/DB/イベントストア連携など Gateway 責務を担う）
- [ ] T021 [US1] バリデーション・エラーハンドリングを組み込む（回復不能エラーはフェイルファスト）
- [ ] T022 [US1] 観測性（ログ・メトリクス）を追加する
- [ ] T023 [US1] ドメインサービスが純粋関数であること、およびリファレンスコードをコピーしていないことをレビューする
- [ ] T024 [US1] コマンドハンドラがイベント保存を主目的に設計され、必要最小限のリプレイ・他集約確認に限定して読み込みを行っていることを確認する

**チェックポイント**: ユーザーストーリー 1 が単独でデプロイ・検証可能になった状態。

---

## フェーズ4: ユーザーストーリー 2 - [タイトル]（優先度: P2）

**ゴール**: [提供価値]

**独立テスト方法**: [検証手順]

### テスト（必須）

- [ ] T025 [P] [US2] ドメイン単体テストを `tests/unit/` に追加する
- [ ] T026 [P] [US2] 契約テストを `tests/contract/` に追加する
- [ ] T027 [P] [US2] 統合テストを `tests/integration/` に追加する

### 実装

- [ ] T028 [P] [US2] 必要なドメインオブジェクトを拡張する
- [ ] T029 [US2] ユースケースサービスを追加・調整する（エラー戻り値を拡張）
- [ ] T030 [US2] インターフェイスアダプタを実装し、US1 との衝突を確認する（例外変換と通知。RPC/DB/イベントストア連携はこちらで実装）
- [ ] T031 [US2] 監査ログや追跡情報を更新する（エラー計測を含む）
- [ ] T032 [US2] ドメインサービスの純粋性をテストし、永続化依存やリファレンスコードのコピーが混入していないことを検証する
- [ ] T033 [US2] コマンドハンドラの読み込みがリプレイ/他集約確認など最小限の目的に限定されていることをレビューし、クエリ責務へ逸脱していないことを確認する

**チェックポイント**: ユーザーストーリー 1 と 2 が互いに独立動作し、受入条件を満たす。

---

## フェーズ5: ユーザーストーリー 3 - [タイトル]（優先度: P3）

**ゴール**: [提供価値]

**独立テスト方法**: [検証手順]

### テスト（必須）

- [ ] T034 [P] [US3] ドメイン単体テストを `tests/unit/` に追加する
- [ ] T035 [P] [US3] 契約テストを `tests/contract/` に追加する
- [ ] T036 [P] [US3] 統合テストを `tests/integration/` に追加する

### 実装

- [ ] T037 [P] [US3] ドメインモデル・ユースケースを拡張する（新しいエラー型を定義）
- [ ] T038 [US3] インターフェイスアダプタを実装する（外部エラーをマッピングし、RPC/DB/イベントストア連携を提供）
- [ ] T039 [US3] 監視・メトリクスを更新する（エラー指標を追加）
- [ ] T040 [US3] ドメインサービスで外部依存が追加されていないか、リファレンスコードがコピーされていないかを静的解析・レビューで確認する
- [ ] T041 [US3] コマンドフロー全体をリプレイし、読み込みが許容範囲に収まっていることとクエリ責務へ逸脱していないことを検証する

**チェックポイント**: すべてのユーザーストーリーが独立稼働できる状態。

---

[必要に応じて追加のユーザーストーリーフェーズを定義する]

---

## フェーズN: 仕上げと横断的対応

**目的**: 全ユースケースにまたがる改善

- [ ] TXXX [P] ドキュメント（quickstart, README 等）を更新する
- [ ] TXXX クリーンアーキテクチャの依存方向が守られているかレビューし、違反箇所を是正する
- [ ] TXXX コードの整備とリファクタリングを行う
- [ ] TXXX 性能検証と最適化を行う
- [ ] TXXX イベントストアのリプレイ・スナップショット手順を検証し、ドキュメントと整合させる
- [ ] TXXX [P] 追加のユニットテストを `tests/unit/` に追加する
- [ ] TXXX セキュリティ診断・ハードニングを実施する
- [ ] TXXX quickstart.md の手順を実際に検証する

---

## 依存関係と実行順序

### フェーズ間依存

- **セットアップ（フェーズ1）**: 依存なし。即時着手可。
- **基盤整備（フェーズ2）**: フェーズ1完了が前提。全ユースケースのブロッカー。
- **ユーザーストーリー（フェーズ3以降）**: フェーズ2完了後に開始。必要なら並列実施。
- **仕上げ（最終フェーズ）**: 目標とするユーザーストーリー完了後に実施。

### ユーザーストーリー間依存

- **US1 (P1)**: フェーズ2完了後に着手。ほかのストーリーへの依存なし。
- **US2 (P2)**: フェーズ2完了後に着手。US1 と連携する場合は契約で明示する。
- **US3 (P3)**: フェーズ2完了後に着手。既存ストーリーとの競合をテストで保証する。

### 各ユーザーストーリー内の順序

- テストを先に記述し、失敗を確認してから実装する。
- ドメインモデル → ユースケースサービス → アダプタ実装の順で進める。
- バリデーションと例外処理をまとめて検証する。
- インターフェースアダプタはユースケース経由でのみドメインへアクセスすることを確認する。
- ストーリー完了前にドキュメント更新とレビュー準備を行う。

### 並列実行のヒント

- `[P]` が付いたセットアップ・基盤タスクはファイルの競合がない範囲で並列化できる。
- 同一ユーザーストーリー内でもファイルが独立していれば `[P]` タスクを並列に実施可能。
- 異なるユーザーストーリーは共通基盤が整備されていれば別担当者で進められる。

---

## 並列実行例: ユーザーストーリー 1

```bash
# ユーザーストーリー1のテストを一括で失敗させる
Task: "ドメイン単体テストを tests/unit/test_[name].ts に追加"
Task: "契約テストを tests/contract/test_[name].ts に追加"
Task: "統合テストを tests/integration/test_[name].ts に追加"

# ユーザーストーリー1のドメインモデルを並列で実装
Task: "値オブジェクトを src/domain/value-objects/[name].ts に追加"
Task: "エンティティを src/domain/entities/[name].ts に追加"
Task: "ユースケースサービスを src/application/use-cases/[name].ts に実装"
Task: "アダプタを src/interfaces/[adapter]/[name].ts に実装（ユースケース経由でドメインへ）"
```

---

## 実装戦略

### MVP ファースト（ユーザーストーリー1のみ）

1. フェーズ1（セットアップ）を完了する。
2. フェーズ2（基盤整備）を完了し、インメモリリポジトリとインフラユーティリティを整備する。
3. フェーズ3（ユーザーストーリー1）を完了する。
4. **検証**: US1 のテストを全て実行し、仕様と一致することを確認。
5. 準備が整えばデプロイ / デモを行う。

### インクリメンタルデリバリー

1. セットアップと基盤整備を完了し、基盤を固定する。
2. US1 を追加 → テスト → デプロイ / デモ。
3. US2 を追加 → テスト → デプロイ / デモ。
4. US3 を追加 → テスト → デプロイ / デモ。
5. 各ストーリーで価値を追加しつつ既存機能を維持する。

### チーム並列戦略

1. チーム全員でフェーズ1・2を完了させ共通基盤を固める。
2. 基盤整備完了後:
   - 開発者A: US1
   - 開発者B: US2
   - 開発者C: US3
3. ストーリー毎に独立テストとドキュメント更新を完了させる。

---

## メモ

- `[P]` タスク = 依存関係が無く並列実行可能。
- `[Story]` ラベルでストーリー単位のトレーサビリティを確保する。
- 各ストーリーは単独で完成・テストできる状態に保つ。
- テストは必ず先に実装し、失敗を確認してから機能実装に進む。
- コミットはタスク単位または論理的なまとまりで行い、関連仕様を参照する。
- 憲章原則（DDD 層構造、仕様ドリブン、テストファースト、ドキュメント同期）に適合しないタスクは正当化し記録する。
