# フィーチャ仕様: [FEATURE NAME]

**フィーチャブランチ**: `[###-feature-name]`  
**作成日**: [DATE]  
**ステータス**: ドラフト  
**入力**: ユーザー要求: "$ARGUMENTS"

## ユーザージャーニーとテスト（必須）

> 優先度順（P1, P2, P3, ...）に並べた独立可能なユーザージャーニーを定義する。  
> 各ジャーニーは単独で価値を提供し、実装・テスト・デプロイ・デモが可能でなければならない。

### ユーザーストーリー 1 - [短いタイトル]（優先度: P1）

[ユーザー視点での体験を平易な日本語で記述する]

**優先理由**: [なぜ P1 なのか、ビジネス価値やリスク低減を明記する]

**独立テスト**: [単独で検証する方法。例: 「[具体的アクション] を実行すると [期待値] が得られることを自動テストで確認できる」]

**受入シナリオ**:

1. **前提** [初期状態]、**操作** [行動]、**結果** [期待される状態]
2. **前提** [初期状態]、**操作** [行動]、**結果** [期待される状態]

---

### ユーザーストーリー 2 - [短いタイトル]（優先度: P2）

[ユーザー視点での体験を平易な日本語で記述する]

**優先理由**: [優先度の根拠]

**独立テスト**: [単独テスト方法]

**受入シナリオ**:

1. **前提** [初期状態]、**操作** [行動]、**結果** [期待される状態]

---

### ユーザーストーリー 3 - [短いタイトル]（優先度: P3）

[ユーザー視点での体験を平易な日本語で記述する]

**優先理由**: [優先度の根拠]

**独立テスト**: [単独テスト方法]

**受入シナリオ**:

1. **前提** [初期状態]、**操作** [行動]、**結果** [期待される状態]

---

[必要に応じてユーザーストーリーを追加する。各ストーリーに優先度を設定すること。]

### エッジケース

- [境界条件] のときどうなるか
- [エラーシナリオ] をどのように扱うか
- ドメイン不変条件や制約違反をどの層で検知するか

## 要件（必須）

### 機能要件

- **FR-001**: システムは [具体的機能。例: 「ユーザーがアカウントを作成できる」] こと。
- **FR-002**: システムは [具体的機能。例: 「入力されたメールアドレスを検証する」] こと。  
- **FR-003**: ユーザーは [主要操作。例: 「パスワードを再設定できる」] こと。
- **FR-004**: システムは [データ要件。例: 「ユーザープロファイルを永続化する」] こと。
- **FR-005**: システムは [振る舞い。例: 「重要イベントを監査ログに記録する」] こと。

*不明点を明示する例:*

- **FR-006**: システムはユーザーを [要確認: 認証方式未決定（メール/パスワード、SSO、OAuth など）] で認証する。
- **FR-007**: システムはデータを [要確認: 保持期間未設定] 保持する。

### ドメインエンティティと値オブジェクト

- **値オブジェクト**: [識別子を持たず不変であること、検証ロジック、許容される値域]
- **エンティティ / 集約ルート**: [識別子、トランザクション境界、不変条件、子要素との関係]
- **ドメインサービス（必要時）**: [複数集約にまたがるルールと副作用の扱い]
- ドメインサービスはエンティティ・値オブジェクトのみを扱う純粋関数とし、リポジトリなどの永続化責務を利用しないことを明記する。
- ドメイン層の不変条件・生成条件・ライフサイクルを明記し、ユビキタス言語を使用する。
- 不正引数・不正状態・到達不能といった回復不能エラーは、どの例外型で検出し、どの層でフェイルファストするかを記録する。

### アプリケーションサービスとポート

- **[ユースケースサービス名]**: [トリガーとなるユースケースと入出力]
- **入力ポート / 出力ポート**: [依存するインターフェイスと契約]
- 既存ユースケースとの依存や排他制御がある場合は明示する。
- **CQRS の方針**: [コマンド/クエリの分離、命名規約、依存方向]
- 回復可能なアプリケーションエラーを `Either` / `Result` 等で返却する設計を明示し、ユースケース単位でエラー型を定義する。

### コマンド & クエリモデル

- **コマンド一覧**: [コマンド名、入力、期待するイベント、検証ルール]
- **クエリ一覧**: [クエリ名、入力、返却するリードモデル、整合性要件]
- **読取/書込分離**: [最終的整合性、レイテンシ、リトライ/補償フロー]

### イベント設計

- **イベントスキーマ**: [イベント名、ペイロード、バージョン、アップキャスト方針]
- **イベント順序**: [ストリーム名、順序保証、集約単位のルール]
- **プロジェクション**: [リードモデル更新方法、投影サービス、エラーハンドリング]

### イベントストア構成

- **ライブラリ設定**: [`@j5ik2o/event-store-adapter-js` の接続情報、使用するストレージバックエンド]
- **スナップショット/リプレイ**: [スナップショット戦略、イベント再生手順、障害復旧手順]
- **監視**: [イベント保存失敗・ストリーム競合の検出と通知方法]

### リポジトリとアダプタ

- **リポジトリインターフェイス**: [必要な操作、整合性ルール、戻り値]
- **インメモリ実装方針**: [テストで扱うデータセット、シミュレートする制約]
- **永続化 / API アダプタ**: [接続先、エラー処理、DTO とドメイン間のマッピング]
- **依存方向の証跡**: [インターフェースアダプタがユースケースを介してドメインに依存し、逆依存がないことを説明]
- **例外変換**: [インフラ層で発生した例外をどの型へ変換するか、境界で握り潰さないことの確認]
- **インフラストラクチャ**: [提供する共通ユーティリティのみ記述し、RPC やデータベースアクセスをここに実装しない方針を明記]

### 開発順序上の前提

- ドメインテスト → モデル実装 → リファクタリング → インメモリリポジトリ → ユースケース → アダプタ → 統合テストの順序で進める根拠を記載する。
- レイヤー構造が崩れるリスクと回避策を明記し、インフラストラクチャ層を横断的関心事のみに限定する。
- エラーの回復可能性やエラー型命名ルールを記述し、仕様内で想定する代替フローと通知方法を定義する。

## 成功指標（必須）

> 技術依存しない測定可能なゴールを定義する。

### 測定可能な成果

- **SC-001**: [測定可能な指標。例: 「ユーザーが主要フローを 2 分以内に完了できる」]
- **SC-002**: [性能指標。例: 「システムが同時 100 リクエストを処理しても p95 が 200ms 未満」]
- **SC-003**: [顧客満足。例: 「ユーザーの 90% が初回試行で目的を達成する」]
- **SC-004**: [ビジネス指標。例: 「対象カテゴリの問い合わせ件数を 50% 削減する」]
